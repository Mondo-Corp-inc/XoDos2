name: Build XoDos (APK + Linux + Windows)

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag (ex: 1.0.3)'
        required: true
        default: '1.0.3'

permissions:
  contents: write

env:
  VERSION_TAG: ${{ github.event.inputs.version_tag }}
  FLUTTER_SDK_ZIP_URL: 'https://github.com/xodiosx/XoDos2/releases/download/v1.0.0/Flutter-SDK-ARM64.zip'

jobs:
  # -------------------------
  # Android build (Ubuntu)
  # -------------------------
  android-build:
    runs-on: ubuntu-latest
    outputs:
      android-present: ${{ steps.check.outputs.present }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check Android platform folder
        id: check
        run: |
          if [ -d "android" ]; then
            echo "present=true" >> $GITHUB_OUTPUT
            echo "Found android/ folder — Android build will run."
          else
            echo "present=false" >> $GITHUB_OUTPUT
            echo "android/ folder not found — skipping Android build."
          fi

      # The rest runs only if android/ exists
      - name: Prepare workspace
        if: steps.check.outputs.present == 'true'
        run: ls -la $HOME

      - name: Cache Flutter SDK
        if: steps.check.outputs.present == 'true'
        id: cache-flutter
        uses: actions/cache@v3
        with:
          path: ~/flutter
          key: flutter-sdk-cache-v1
          restore-keys: |
            flutter-sdk-cache-

      - name: Download & extract Flutter SDK (ZIP) or fallback to git
        if: steps.check.outputs.present == 'true' && steps.cache-flutter.outputs.cache-hit != 'true'
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y unzip curl git || true
          echo "Downloading Flutter SDK from $FLUTTER_SDK_ZIP_URL"
          curl -L -sS "$FLUTTER_SDK_ZIP_URL" -o flutter.zip
          unzip -q flutter.zip -d $HOME || true
          if [ -d "$HOME/flutter" ]; then
            echo "Flutter folder exists at $HOME/flutter"
          else
            found=$(find $HOME -maxdepth 2 -type d -name "flutter*" | head -n 1 || true)
            if [ -n "$found" ]; then
              mv "$found" "$HOME/flutter"
            fi
          fi
          if [ -x "$HOME/flutter/bin/flutter" ]; then
            $HOME/flutter/bin/flutter --version || true
          else
            rm -rf $HOME/flutter || true
            git clone --depth 1 -b stable https://github.com/flutter/flutter.git $HOME/flutter
          fi

      - name: Add Flutter to PATH
        if: steps.check.outputs.present == 'true'
        run: |
          echo "$HOME/flutter/bin" >> $GITHUB_PATH
          export PATH="$HOME/flutter/bin:$PATH"
          flutter --version

      - name: Set ANDROID_HOME and PATH
        if: steps.check.outputs.present == 'true'
        run: |
          echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
          echo "PATH=$HOME/android-sdk/platform-tools:$HOME/android-sdk/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV

      - name: Cache Android SDK
        if: steps.check.outputs.present == 'true'
        id: cache-android
        uses: actions/cache@v3
        with:
          path: ~/android-sdk
          key: android-sdk-cache-v1
          restore-keys: |
            android-sdk-cache-

      - name: Ensure Android SDK command-line tools & packages
        if: steps.check.outputs.present == 'true'
        run: |
          export ANDROID_HOME="$HOME/android-sdk"
          export PATH="$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmdline-tools/latest/bin:$PATH"
          if ! command -v sdkmanager >/dev/null 2>&1; then
            mkdir -p "$ANDROID_HOME"
            curl -sS -L "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip" -o cmdline-tools.zip
            unzip -q cmdline-tools.zip -d "$ANDROID_HOME/cmdline-tools"
            if [ -d "$ANDROID_HOME/cmdline-tools/cmdline-tools" ]; then
              mv "$ANDROID_HOME/cmdline-tools/cmdline-tools" "$ANDROID_HOME/cmdline-tools/latest"
            else
              mv "$ANDROID_HOME/cmdline-tools" "$ANDROID_HOME/cmdline-tools/latest"
            fi
          fi
          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_HOME" \
            "platforms;android-36" "build-tools;36.0.0" "platform-tools" "ndk;27.1.12297006" || true
          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --licenses || true

      - name: Cache Gradle
        if: steps.check.outputs.present == 'true'
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Cache pub packages
        if: steps.check.outputs.present == 'true'
        uses: actions/cache@v3
        with:
          path: ~/.pub-cache
          key: flutter-packages-${{ hashFiles('pubspec.yaml') }}

      - name: Verify environment
        if: steps.check.outputs.present == 'true'
        run: |
          echo "Flutter: $(which flutter || echo 'not found')"
          flutter --version || true
          flutter doctor -v || true

      - name: Pub get
        if: steps.check.outputs.present == 'true'
        run: flutter pub get

      - name: Build APK (release)
        if: steps.check.outputs.present == 'true'
        run: flutter build apk --target-platform android-arm64 --split-per-abi

      - name: Prepare APK artifact and MD5
        if: steps.check.outputs.present == 'true'
        run: |
          cd build/app/outputs/flutter-apk
          cp app-arm64-v8a-release.apk XoDos-${{ env.VERSION_TAG }}-arm64-v8a.apk
          md5sum app-arm64-v8a-release.apk > md5.txt
          ls -la

      - name: Upload APK artifact
        if: steps.check.outputs.present == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: |
            build/app/outputs/flutter-apk/XoDos-${{ env.VERSION_TAG }}-arm64-v8a.apk
            build/app/outputs/flutter-apk/md5.txt

  # -------------------------
  # Linux desktop build (Ubuntu)
  # -------------------------
  linux-build:
    runs-on: ubuntu-latest
    needs: android-build
    outputs:
      linux-present: ${{ steps.check.outputs.present }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check linux platform folder
        id: check
        run: |
          if [ -d "linux" ]; then
            echo "present=true" >> $GITHUB_OUTPUT
            echo "Found linux/ folder — Linux build will run."
          else
            echo "present=false" >> $GITHUB_OUTPUT
            echo "linux/ folder not found — skipping Linux build."
          fi

      - name: Ensure Linux build dependencies
        if: steps.check.outputs.present == 'true'
        run: |
          sudo apt-get update -y
          if ! dpkg -s libgtk-3-dev >/dev/null 2>&1; then
            sudo apt-get install -y libgtk-3-dev libglu1-mesa-dev build-essential xz-utils unzip curl git
          fi
          if ! command -v cmake >/dev/null 2>&1; then
            sudo apt-get install -y cmake
          fi
          if ! command -v ninja >/dev/null 2>&1; then
            sudo apt-get install -y ninja-build
          fi

      - name: Cache Flutter SDK (Linux)
        if: steps.check.outputs.present == 'true'
        id: cache-flutter-linux
        uses: actions/cache@v3
        with:
          path: ~/flutter
          key: flutter-sdk-cache-linux-v1
          restore-keys: |
            flutter-sdk-cache-linux-

      - name: Download & extract Flutter SDK (ZIP) or fallback to git (Linux)
        if: steps.check.outputs.present == 'true' && steps.cache-flutter-linux.outputs.cache-hit != 'true'
        run: |
          set -e
          echo "Downloading Flutter SDK from $FLUTTER_SDK_ZIP_URL"
          curl -L -sS "$FLUTTER_SDK_ZIP_URL" -o flutter.zip
          unzip -q flutter.zip -d $HOME || true
          if [ -d "$HOME/flutter" ]; then
            echo "Flutter folder exists at $HOME/flutter"
          else
            found=$(find $HOME -maxdepth 2 -type d -name "flutter*" | head -n 1 || true)
            if [ -n "$found" ]; then
              mv "$found" "$HOME/flutter"
            fi
          fi
          if [ -x "$HOME/flutter/bin/flutter" ]; then
            $HOME/flutter/bin/flutter --version || true
          else
            rm -rf $HOME/flutter || true
            git clone --depth 1 -b stable https://github.com/flutter/flutter.git $HOME/flutter
          fi

      - name: Add Flutter to PATH
        if: steps.check.outputs.present == 'true'
        run: |
          echo "$HOME/flutter/bin" >> $GITHUB_PATH
          export PATH="$HOME/flutter/bin:$PATH"
          flutter --version

      - name: Enable linux desktop
        if: steps.check.outputs.present == 'true'
        run: |
          flutter config --enable-linux-desktop
          flutter doctor -v

      - name: Pub get
        if: steps.check.outputs.present == 'true'
        run: flutter pub get

      - name: Build Linux release bundle
        if: steps.check.outputs.present == 'true'
        run: |
          flutter build linux --release
          BUNDLE_DIR=build/linux/x64/release/bundle
          if [ -d "$BUNDLE_DIR" ]; then
            cd $BUNDLE_DIR
            tar -czf XoDos-${{ env.VERSION_TAG }}-linux-x86_64.tar.gz .
            ls -la
          else
            echo "Linux bundle not found" && exit 1
          fi

      - name: Upload Linux artifact
        if: steps.check.outputs.present == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: linux-bundle
          path: build/linux/x64/release/bundle/XoDos-${{ env.VERSION_TAG }}-linux-x86_64.tar.gz

  # -------------------------
  # Windows desktop build (Windows)
  # -------------------------
  windows-build:
    runs-on: windows-latest
    needs: android-build
    outputs:
      windows-present: ${{ steps.check.outputs.present }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check windows platform folder
        id: check
        shell: powershell
        run: |
          if (Test-Path "windows") {
            Write-Host "Found windows/ folder — Windows build will run."
            Write-Host "present=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "windows/ folder not found — skipping Windows build."
            Write-Host "present=false" >> $env:GITHUB_OUTPUT
          }

      - name: Cache Flutter SDK (Windows)
        if: steps.check.outputs.present == 'true'
        id: cache-flutter-win
        uses: actions/cache@v3
        with:
          path: C:\flutter
          key: flutter-sdk-cache-windows-v1
          restore-keys: |
            flutter-sdk-cache-windows-

      - name: Download & extract Flutter SDK (ZIP) or fallback to git (Windows)
        if: steps.check.outputs.present == 'true' && steps.cache-flutter-win.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          try {
            Invoke-WebRequest -Uri $env:FLUTTER_SDK_ZIP_URL -OutFile flutter.zip -UseBasicParsing
            Expand-Archive -Path flutter.zip -DestinationPath C:\ -Force
          } catch {
            Write-Warning "Failed to download/extract ZIP: $_"
            git clone --depth 1 -b stable https://github.com/flutter/flutter.git C:\flutter
          }
          if (-not (Test-Path 'C:\flutter\bin\flutter.bat')) {
            git clone --depth 1 -b stable https://github.com/flutter/flutter.git C:\flutter
          }

      - name: Add Flutter to PATH (Windows)
        if: steps.check.outputs.present == 'true'
        shell: powershell
        run: |
          echo "C:\flutter\bin" >> $env:GITHUB_PATH
          $env:PATH = "C:\flutter\bin;" + $env:PATH
          flutter --version

      - name: Ensure Windows build prerequisites (detect & install allowed components)
        if: steps.check.outputs.present == 'true'
        shell: powershell
        run: |
          $cl = Get-Command cl.exe -ErrorAction SilentlyContinue
          if ($null -ne $cl) {
            Write-Host "MSVC found at: $($cl.Path)"
          } else {
            Write-Warning "cl.exe not found. Trying vswhere..."
            $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
            if (Test-Path $vswhere) {
              $instPath = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
              if ($instPath) {
                $msvc = Get-ChildItem -Path "$instPath\VC\Tools\MSVC" -Directory -ErrorAction SilentlyContinue | Sort-Object Name -Descending | Select-Object -First 1
                if ($msvc) {
                  $binPath = Join-Path $msvc.FullName "bin\Hostx64\x64"
                  if (Test-Path $binPath) {
                    echo $binPath >> $env:GITHUB_PATH
                  }
                }
              }
            }
          }
          function Install-ChocoIfMissing($name, $installArgs) {
            if (-not (Get-Command $name -ErrorAction SilentlyContinue)) {
              choco install $name -y --no-progress $installArgs
            }
          }
          Install-ChocoIfMissing -name "ninja" -installArgs ""
          Install-ChocoIfMissing -name "cmake" -installArgs "--installargs 'ADD_CMAKE_TO_PATH=System'"
          Install-ChocoIfMissing -name "git" -installArgs ""
          flutter doctor -v
          if (-not (Get-Command cl.exe -ErrorAction SilentlyContinue)) {
            Write-Error "MSVC (cl.exe) not found. The job cannot continue. Ensure runner has 'Desktop development with C++' workload."
            exit 1
          }

      - name: Enable windows desktop
        if: steps.check.outputs.present == 'true'
        shell: powershell
        run: |
          flutter config --enable-windows-desktop
          flutter doctor -v

      - name: Pub get (Windows)
        if: steps.check.outputs.present == 'true'
        shell: powershell
        run: flutter pub get

      - name: Build Windows release
        if: steps.check.outputs.present == 'true'
        shell: powershell
        run: |
          flutter build windows --release
          $out = "build\windows\runner\Release"
          if (Test-Path $out) {
            $zipName = "XoDos-${{ env.VERSION_TAG }}-windows-x86_64.zip"
            if (Test-Path $zipName) { Remove-Item $zipName -Force }
            Add-Type -AssemblyName System.IO.Compression.FileSystem
            [System.IO.Compression.ZipFile]::CreateFromDirectory($out, $zipName)
            Get-ChildItem -Path . -Filter $zipName
          } else {
            Write-Error "Windows release folder not found"
            exit 1
          }

      - name: Upload Windows artifact
        if: steps.check.outputs.present == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: XoDos-${{ env.VERSION_TAG }}-windows-x86_64.zip

  # -------------------------
  # Release: gather artifacts, create tag and GitHub Release
  # -------------------------
  release:
    runs-on: ubuntu-latest
    needs: [android-build, linux-build, windows-build]
    steps:
      - name: Create Git Tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag "v${{ env.VERSION_TAG }}" || true
          git push origin "v${{ env.VERSION_TAG }}" || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release (empty - we'll attach assets conditionally)
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ env.VERSION_TAG }}
          release_name: XoDos ${{ env.VERSION_TAG }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Download + attach Android artifact if present
      - name: Download Android artifact (if produced)
        if: ${{ needs.android-build.outputs.android-present == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: artifacts/android

      - name: Upload Android release asset
        if: ${{ needs.android-build.outputs.android-present == 'true' }}
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/android/XoDos-${{ env.VERSION_TAG }}-arm64-v8a.apk
          asset_name: XoDos-${{ env.VERSION_TAG }}-arm64-v8a.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Upload Android MD5 (optional)
        if: ${{ needs.android-build.outputs.android-present == 'true' }}
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/android/md5.txt
          asset_name: XoDos-${{ env.VERSION_TAG }}-arm64-v8a.md5.txt
          asset_content_type: text/plain

      # Download + attach Linux artifact if present
      - name: Download Linux artifact (if produced)
        if: ${{ needs.linux-build.outputs.linux-present == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: linux-bundle
          path: artifacts/linux

      - name: Upload Linux release asset
        if: ${{ needs.linux-build.outputs.linux-present == 'true' }}
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/linux/XoDos-${{ env.VERSION_TAG }}-linux-x86_64.tar.gz
          asset_name: XoDos-${{ env.VERSION_TAG }}-linux-x86_64.tar.gz
          asset_content_type: application/gzip

      # Download + attach Windows artifact if present
      - name: Download Windows artifact (if produced)
        if: ${{ needs.windows-build.outputs.windows-present == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: windows-zip
          path: artifacts/windows

      - name: Upload Windows release asset
        if: ${{ needs.windows-build.outputs.windows-present == 'true' }}
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/windows/XoDos-${{ env.VERSION_TAG }}-windows-x86_64.zip
          asset_name: XoDos-${{ env.VERSION_TAG }}-windows-x86_64.zip
          asset_content_type: application/zip

      - name: Show release URL
        run: |
          echo "Release created: ${{ steps.create_release.outputs.html_url || 'unknown' }}"
